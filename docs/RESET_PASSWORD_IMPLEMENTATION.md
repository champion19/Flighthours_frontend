# Reset Password Feature Implementation

## Summary
Implementation of the password reset feature for the Flight Hours App Flutter application. This feature allows users to request a password reset email by entering their email address.

## Date
December 27, 2025

## Backend Endpoint
- **URL**: `POST /flighthours/api/v1/auth/password-reset`
- **Request Body**:
```json
{
  "email": "user@example.com"
}
```
- **Response (Success - 200)**:
```json
{
  "success": true,
  "code": "MOD_KC_PWD_RESET_SENT_EXI_00001",
  "message": "A password reset email has been sent to your inbox. Please check your email and follow the instructions."
}
```

## Architecture
Following Clean Architecture pattern with BLoC for state management.

## Files Created

### Data Layer
| File | Purpose |
|------|---------|
| `lib/features/reset_password/data/datasources/reset_password_datasource.dart` | HTTP client that calls the backend `/auth/password-reset` endpoint |
| `lib/features/reset_password/data/models/reset_password_response_model.dart` | Model to parse the backend JSON response |
| `lib/features/reset_password/data/repositories/reset_password_repository_impl.dart` | Repository implementation |

### Domain Layer
| File | Purpose |
|------|---------|
| `lib/features/reset_password/domain/entities/reset_password_entity.dart` | Domain entity for password reset result |
| `lib/features/reset_password/domain/repositories/reset_password_repository.dart` | Abstract repository interface |
| `lib/features/reset_password/domain/usecases/reset_password_use_case.dart` | Use case encapsulating business logic |

### Presentation Layer
| File | Purpose |
|------|---------|
| `lib/features/reset_password/presentation/bloc/reset_password_bloc.dart` | BLoC for managing state |
| `lib/features/reset_password/presentation/bloc/reset_password_event.dart` | BLoC events |
| `lib/features/reset_password/presentation/bloc/reset_password_state.dart` | BLoC states |
| `lib/features/reset_password/presentation/pages/reset_password_page.dart` | Main page with UI and BLoC integration |
| `lib/features/reset_password/presentation/widgets/reset_password_form.dart` | Form widget with email input |

## Files Modified

| File | Changes |
|------|---------|
| `lib/core/injector/injector.dart` | Added imports and factory registrations for reset password dependencies |
| `lib/core/injector/injector.g.dart` | Auto-generated by build_runner with new dependencies |
| `lib/main.dart` | Added import and route `/reset-password` |
| `lib/features/login/presentation/widgets/login_form.dart` | Added "Forgot Password?" link |

## Features

### User Flow
1. User is on the Login page
2. User clicks "Forgot Password?" link
3. User is navigated to Reset Password page
4. User enters their email address
5. User clicks "Send Reset Link"
6. On success: Dialog shows confirmation message with option to return to login
7. On error: SnackBar shows error message

### States
- `ResetPasswordInitial` - Initial state
- `ResetPasswordLoading` - Request in progress
- `ResetPasswordSuccess` - Email sent successfully
- `ResetPasswordError` - Error occurred (with message and code)

## Navigation
- Route: `/reset-password`
- Accessible from: Login page via "Forgot Password?" link
- Returns to: Login page after successful submission

## How to Test
1. Run the Flutter app
2. Navigate to Login page
3. Click "Forgot Password?" link
4. Enter a registered email address
5. Click "Send Reset Link"
6. Verify success dialog appears with backend message
7. Click "Back to Login" to return

## Dependencies
No new dependencies were added. Uses existing:
- `http` - For HTTP requests
- `flutter_bloc` - For state management
- `equatable` - For state comparison
- `kiwi` - For dependency injection

## Commands Used
```bash
# Regenerate dependency injection
flutter pub run build_runner build --delete-conflicting-outputs

# Analyze code
flutter analyze lib/features/reset_password
```

## Error Handling
- Network errors display a connection error message
- Backend errors display the error message from the response
- All errors are caught and displayed via SnackBar

## Bug Fix Applied
During initial testing, we encountered a `ProviderNotFoundError`:
```
Could not find the correct Provider<ResetPasswordBloc> above this ResetPasswordPage Widget
```

**Cause**: The `context` used in the `onSubmit` callback was from `ResetPasswordPage` (parent of `BlocProvider`), not from a widget inside the `BlocProvider`.

**Solution**: Wrapped the content with `Builder` widget to get `blocContext` which has access to the `ResetPasswordBloc`:

```dart
return BlocProvider(
  create: (context) => ResetPasswordBloc(),
  child: Builder(
    builder: (blocContext) => Scaffold(  // blocContext has access to BLoC
      // ...
      onSubmit: (email) {
        blocContext.read<ResetPasswordBloc>().add(...);  // âœ… Works
      },
    ),
  ),
);
```
